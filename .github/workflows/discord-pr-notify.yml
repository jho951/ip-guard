name: Notify Discord on PR

on:
  pull_request:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Check Discord webhook env
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "âŒ DISCORD_WEBHOOK_URL is EMPTY. Check your GitHub Actions secret."
            exit 1
          fi
          echo "âœ… DISCORD_WEBHOOK_URL is set. (length: ${#DISCORD_WEBHOOK_URL})"

      - name: Send message to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          repo="${{ github.repository }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"
          pr_url="${{ github.event.pull_request.html_url }}"
          author="${{ github.event.pull_request.user.login }}"
          
          # ë©”ì‹œì§€ ë³¸ë¬¸ êµ¬ì„±
          content="ğŸ”” **ìƒˆë¡œìš´ PR ì•Œë¦¼**\nğŸ“¦ **Repo**: ${repo}\nğŸ”¢ **PR**: #${pr_number}\nâœï¸ **ì œëª©**: ${pr_title}\nğŸ‘¤ **ì‘ì„±ì**: ${author}\nğŸ”— **ë§í¬**: ${pr_url}"
          
          # JSON ë‚´ë¶€ì—ì„œ ë¬¸ìê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡ pythonì„ ì‚¬ìš©í•´ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
          json_content=$(printf '%s' "$content" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          
          # ğŸš€ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„: -H "User-Agent: ..." ì¶”ê°€
          echo "ğŸ“¤ Sending payload to Discord..."
          curl -sS \
               -H "Content-Type: application/json" \
               -H "User-Agent: GitHub-Actions-Discord-Bot" \
               -X POST \
               -d "{\"content\": ${json_content}}" \
               "$DISCORD_WEBHOOK_URL"