name: Notify Discord on PR

on:
  pull_request:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Check Discord webhook env
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "âŒ DISCORD_WEBHOOK_URL is EMPTY. Check your GitHub Actions secret."
            exit 1
          fi
          echo "âœ… DISCORD_WEBHOOK_URL is set. (length: ${#DISCORD_WEBHOOK_URL})"

      - name: Send message to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          repo="${{ github.repository }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"
          pr_url="${{ github.event.pull_request.html_url }}"
          author="${{ github.event.pull_request.user.login }}"

          content="ğŸ”” ìƒˆë¡œìš´ PR ì•Œë¦¼\n"
          content+="ğŸ“¦ Repository: ${repo}\n"
          content+="ğŸ”¢ PR: #${pr_number}\n"
          content+="âœï¸ ì œëª©: ${pr_title}\n"
          content+="ğŸ‘¤ ì‘ì„±ì: ${author}\n"
          content+="ğŸ”— ë§í¬: ${pr_url}"

          # ì¤„ë°”ê¿ˆì„ \n ìœ¼ë¡œ ë°”ê¿”ì„œ JSONì— ì•ˆì „í•˜ê²Œ ë„£ê¸°
          json_content=$(printf '%s' "$content" | python -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          payload="{\"content\": ${json_content}}"

          echo "ğŸ“¤ Sending payload to Discord..."
          curl -sS -H "Content-Type: application/json" \
               -X POST \
               -d "$payload" \
               "$DISCORD_WEBHOOK_URL"
